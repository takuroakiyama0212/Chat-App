<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Chat App</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; display: flex; justify-content: center; align-items: center; }
    .container { width: 100%; max-width: 560px; padding: 16px; }
    .panel { background: #16213e; border-radius: 16px; padding: 24px; box-shadow: 0 6px 28px rgba(0,0,0,0.35); }
    h2 { margin-bottom: 20px; color: #e94560; text-align: center; }
    input, button { width: 100%; padding: 14px; margin-bottom: 14px; border: none; border-radius: 8px; font-size: 16px; }
    input { background: #0f3460; color: #fff; }
    input::placeholder { color: #888; }
    button { background: #e94560; color: #fff; cursor: pointer; font-weight: bold; transition: background 0.2s; }
    button:hover { background: #ff6b6b; }
    .divider { display: flex; align-items: center; gap: 10px; margin: 10px 0 14px; color: #a0a0a0; font-size: 12px; }
    .divider::before, .divider::after { content: ""; flex: 1; height: 1px; background: #2b3f71; opacity: 0.8; }
    .google-wrap { display: flex; flex-direction: column; gap: 8px; align-items: center; justify-content: center; margin-bottom: 14px; }
    .google-hint { display: none; font-size: 12px; color: #a0a0a0; text-align: center; line-height: 1.4; }
    .google-fallback-btn {
      width: 320px;
      max-width: 100%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid #2b3f71;
      background: #0f3460;
      color: #eaeaea;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s, opacity 0.2s;
    }
    .google-fallback-btn:hover { background: #213d74; }
    .google-fallback-btn[disabled] { opacity: 0.55; cursor: not-allowed; }
    .google-g { width: 18px; height: 18px; border-radius: 50%; background: #fff; color: #4285F4; display: inline-flex; align-items: center; justify-content: center; font-weight: 900; font-family: Arial, sans-serif; }
    .password-group { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; margin-bottom: 14px; }
    .password-group input, .password-group .toggle-btn { margin-bottom: 0; }
    .toggle-btn { width: auto; background: #0f3460; color: #ccc; border: 1px solid #2b3f71; padding: 12px; font-weight: 600; }
    .toggle-btn:hover { background: #213d74; }
    .backend-row { display: none; grid-template-columns: 1fr auto; gap: 8px; align-items: center; margin-bottom: 14px; }
    .backend-row input { margin-bottom: 0; }
    .backend-row button { width: auto; margin-bottom: 0; padding: 14px 18px; background: #0f3460; border: 1px solid #2b3f71; color: #eaeaea; }
    .backend-row button:hover { background: #213d74; }
    .tiny-help { font-size: 12px; color: #a0a0a0; margin-top: -8px; margin-bottom: 14px; line-height: 1.35; display: none; }
    .link-text { text-align: center; margin-top: 16px; color: #888; }
    .link-text a { color: #e94560; text-decoration: none; }
    .link-text a:hover { text-decoration: underline; }
    #chat { display: none; }
    #messages { height: 68vh; overflow-y: auto; background: #0f3460; border-radius: 16px; padding: 16px 18px; margin-bottom: 12px; display: flex; flex-direction: column; gap: 14px; }
    .send-group { display: flex; gap: 8px; }
    .send-group input { flex: 1; margin-bottom: 0; }
    .send-group button { width: auto; padding: 14px 24px; }
    .error { background: #ff6b6b22; color: #ff6b6b; padding: 12px; border-radius: 8px; margin-bottom: 14px; text-align: center; display: none; }
    .message-row { display: flex; align-items: flex-end; }
    .message-row.them { justify-content: flex-start; }
    .message-row.me { justify-content: flex-end; }
    .message-col { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; max-width: 100%; }
    .message-row.me .message-col { align-items: flex-end; }
    .message-line { display: flex; align-items: flex-end; gap: 6px; max-width: 100%; }
    .message-row.me .message-line { justify-content: flex-end; }
    .bubble { display: inline-block; max-width: 85%; min-width: 60px; padding: 10px 14px; border-radius: 18px; position: relative; word-break: break-word; white-space: normal; font-size: 15px; line-height: 1.55; }
    .bubble.them { background: #1a1a2e; border: 1px solid #23345c; color: #f2f2f2; border-radius: 18px 18px 18px 2px; }
    .bubble.me { background: #00b900; color: #fff; border-radius: 18px 18px 2px 18px; }
    .message-text { white-space: pre-wrap; word-break: break-word; }
    .meta { display: flex; gap: 6px; font-size: 10px; opacity: 0.75; align-items: center; white-space: nowrap; margin-top: 2px; justify-content: flex-end; align-self: flex-end; text-align: right; }
    .name-tag { font-size: 14px; font-weight: 600; color: #9dc5ff; margin-left: 6px; }
    .message-row.me .name-tag { align-self: flex-end; margin-right: 6px; margin-left: 0; }
    .read-label { color: #e0ffe0; visibility: hidden; font-weight: 600; font-size: 11px; }

    @media (min-width: 900px) {
      .container { max-width: 760px; }
      #messages { height: 70vh; }
      .message-line { gap: 8px; }
    }

    .bubble {
      display: inline-flex !important;
      align-items: center;
      justify-content: flex-start;
      padding: 10px 16px;
      border-radius: 18px;
      background-color: #00b900;
      color: #fff;
      max-width: 75%;
      min-width: 80px;
      line-height: 1.6;
      word-break: break-word;
      white-space: normal !important;
    }
    .message-text {
      display: inline !important;
      white-space: normal !important;
      word-break: break-word !important;
    }
    .message-row.me .bubble {
      align-self: flex-end;
      border-radius: 18px 18px 2px 18px;
    }
    .message-row.them .bubble {
      align-self: flex-start;
      background-color: #1a1a2e;
      color: #f2f2f2;
      border-radius: 18px 18px 18px 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="loginSection" class="panel">
      <h2>Login</h2>
      <div id="error" class="error"></div>
      <div id="backendRow" class="backend-row">
        <input type="text" id="backendUrlInput" placeholder="Backend URL (e.g. https://your-server.com)">
        <button type="button" id="saveBackendBtn">Save</button>
      </div>
      <div id="backendHelp" class="tiny-help">
        You are on Firebase Hosting. To use login/chat, set the backend URL (your Node/Socket.IO server).
      </div>
      <input type="text" id="username" placeholder="Username">
      <div class="password-group">
        <input type="password" id="password" placeholder="Password">
        <button type="button" id="togglePassword" class="toggle-btn">Show</button>
      </div>
      <button id="loginBtn">Login</button>
      <div class="divider">or</div>
      <div id="googleWrap" class="google-wrap">
        <button type="button" id="googleFallbackBtn" class="google-fallback-btn">
          <span class="google-g">G</span>
          Continue with Google
        </button>
        <div id="googleBtn"></div>
        <div id="googleHint" class="google-hint"></div>
      </div>
      <div class="link-text">
        Don't have an account? <a href="register.html">Register</a>
      </div>
    </div>

    <div id="chat" class="panel">
      <h2>Messages</h2>
      <div id="messages"></div>
      <div class="send-group">
        <input type="text" id="msgInput" placeholder="Type a message...">
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    let token = null;
    let socket = null;
    let currentUser = null;
    const readLabels = new Map();
    const sentReadFor = new Set();

    const error = document.getElementById('error');
    const googleFallbackBtn = document.getElementById('googleFallbackBtn');
    const googleBtn = document.getElementById('googleBtn');
    const googleHint = document.getElementById('googleHint');
    const backendRow = document.getElementById('backendRow');
    const backendUrlInput = document.getElementById('backendUrlInput');
    const saveBackendBtn = document.getElementById('saveBackendBtn');
    const backendHelp = document.getElementById('backendHelp');

    function showError(msg) {
      error.textContent = msg;
      error.style.display = 'block';
    }

    function getBackendBaseUrl() {
      // On Firebase Hosting, the Node/Socket.IO server is not available by default.
      // Allow configuring an external backend URL via localStorage.
      const host = window.location.hostname || '';
      const isFirebaseHosting = host.endsWith('.web.app') || host.endsWith('.firebaseapp.com');
      if (!isFirebaseHosting) return window.location.origin;
      const stored = localStorage.getItem('backendUrl');
      return stored ? stored.replace(/\/+$/, '') : null;
    }

    function isFirebaseHosting() {
      const host = window.location.hostname || '';
      return host.endsWith('.web.app') || host.endsWith('.firebaseapp.com');
    }

    function initBackendUi() {
      if (!isFirebaseHosting()) return;
      backendRow.style.display = 'grid';
      backendHelp.style.display = 'block';
      const stored = localStorage.getItem('backendUrl') || '';
      backendUrlInput.value = stored;
      saveBackendBtn.onclick = () => {
        const v = (backendUrlInput.value || '').trim().replace(/\/+$/, '');
        if (!v) {
          localStorage.removeItem('backendUrl');
          showError('Backend URL cleared. Set it to enable login/chat.');
          return;
        }
        localStorage.setItem('backendUrl', v);
        showError('Backend URL saved. Please reload the page.');
      };
    }

    async function fetchJsonSafe(url) {
      const res = await fetch(url, { credentials: 'omit' });
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch (_) {
        return null;
      }
    }

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });
    }

    async function ensureSocketIoLoaded(baseUrl) {
      if (window.io) return window.io;
      await loadScript(`${baseUrl}/socket.io/socket.io.js`);
      if (!window.io) throw new Error('Socket.IO client failed to load');
      return window.io;
    }

    async function initLoginProviders() {
      const embeddedFirebaseConfig = {
        apiKey: "AIzaSyB5vcDxVhSZuNwojIuLV7CzdD2CyjlS_k8",
        authDomain: "chat-app-12ed6.firebaseapp.com",
        projectId: "chat-app-12ed6",
        storageBucket: "chat-app-12ed6.firebasestorage.app",
        messagingSenderId: "697873574008",
        appId: "1:697873574008:web:ad542d50f9e1ec45d6658d",
        measurementId: "G-WJ2CPN9660"
      };

      const backendBaseUrl = getBackendBaseUrl();
      const cfg = backendBaseUrl ? (await fetchJsonSafe(`${backendBaseUrl}/config`)) : null;

      // ---- Firebase Auth (Google) ----
      const firebaseConfig = cfg?.firebase?.webConfig || embeddedFirebaseConfig;

      if (firebaseConfig?.apiKey && firebaseConfig?.authDomain && firebaseConfig?.projectId) {
        try {
          const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
          const { getAuth, GoogleAuthProvider, signInWithPopup } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
          const { getAnalytics } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js');

          const app = initializeApp(firebaseConfig);
          try { if (firebaseConfig.measurementId) getAnalytics(app); } catch (_) {}
          const auth = getAuth(app);
          const provider = new GoogleAuthProvider();

          googleFallbackBtn.disabled = false;
          googleHint.style.display = 'none';

          googleFallbackBtn.onclick = async () => {
            try {
              // If popup is blocked, we fall back to redirect flow.
              let cred;
              try {
                cred = await signInWithPopup(auth, provider);
              } catch (e) {
                if (e?.code === 'auth/popup-blocked' || e?.code === 'auth/popup-closed-by-user') {
                  const { signInWithRedirect } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                  await signInWithRedirect(auth, provider);
                  return;
                }
                throw e;
              }

              const idToken = await cred.user.getIdToken();
              // If no backend is configured (Firebase Hosting), still consider the user "signed in"
              // and show a hint that chat requires a backend.
              if (!backendBaseUrl) {
                currentUser = cred.user.email || cred.user.uid || 'firebase-user';
                token = idToken;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('chat').style.display = 'block';
                showError('Signed in with Firebase. Chat server is not configured on Firebase Hosting. Set localStorage backendUrl to your server URL to enable chat.');
                return;
              }

              const r = await fetch(`${backendBaseUrl}/auth/firebase`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idToken })
              });
              const json = await r.json();
              if (json.token) {
                currentUser = json.username || currentUser;
                token = json.token;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('chat').style.display = 'block';
                connectSocket();
                error.style.display = 'none';
              } else {
                showError(json.error || 'Firebase login failed');
              }
            } catch (e) {
              const code = e?.code ? ` (${e.code})` : '';
              let hint = '';
              if (e?.code === 'auth/unauthorized-domain') {
                hint = ' / Firebase Console → Authentication → Settings → Authorized domains に、このアクセス元ドメインを追加してください（例: localhost または 127.0.0.1）。';
              } else if (e?.code === 'auth/operation-not-allowed') {
                hint = ' / Firebase Console → Authentication → Sign-in method で Google を有効化してください。';
              } else if (e?.code === 'auth/popup-blocked') {
                hint = ' / ポップアップがブロックされています。ブラウザで許可してください。';
              }
              showError(`Firebase login failed${code}: ${e?.message || 'Unknown error'}${hint}`);
            }
          };

          // Hide Google Identity button area when Firebase is configured (to avoid confusion).
          googleBtn.style.display = 'none';
          return;
        } catch (e) {
          // Fall through to Google Identity
        }
      }

      // ---- Google Identity Services (optional) ----
      const googleClientId = cfg?.googleClientId || null;
      if (!googleClientId) {
        googleHint.textContent = 'Googleログイン(GIS)は未設定です。Firebaseボタンを使うか、バックエンドを設定してください。';
        googleHint.style.display = 'block';
        return;
      }
      if (!window.google?.accounts?.id) {
        googleHint.textContent = 'Googleログインの読み込みに失敗しました。ページを再読み込みしてください。';
        googleHint.style.display = 'block';
        return;
      }

      google.accounts.id.initialize({
        client_id: googleClientId,
        callback: handleGoogleCredential
      });
      google.accounts.id.renderButton(googleBtn, {
        theme: 'outline',
        size: 'large',
        width: 320,
        text: 'signin_with'
      });
      googleHint.style.display = 'none';
      googleFallbackBtn.style.display = 'none';
    }

    async function handleGoogleCredential(response) {
      try {
        const backendBaseUrl = getBackendBaseUrl();
        if (!backendBaseUrl) {
          showError('Backend URL is not set. Please set it (Backend URL) to use Google login.');
          return;
        }
        const res = await fetch(`${backendBaseUrl}/auth/google`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ credential: response.credential })
        });
        const text = await res.text();
        const data = (() => { try { return JSON.parse(text); } catch (_) { return null; } })();
        if (data.token) {
          currentUser = data.username || currentUser;
          token = data.token;
          document.getElementById('loginSection').style.display = 'none';
          document.getElementById('chat').style.display = 'block';
          connectSocket();
          error.style.display = 'none';
        } else {
          showError(data.error || 'Google login failed');
        }
      } catch (err) {
        showError('Connection error');
      }
    }

    async function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      if (!username || !password) {
        showError('Please enter username and password');
        return;
      }

      try {
        const backendBaseUrl = getBackendBaseUrl();
        if (!backendBaseUrl) {
          showError('Backend URL is not set. Please set it (Backend URL) to use username/password login.');
          return;
        }
        const res = await fetch(`${backendBaseUrl}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const text = await res.text();
        const data = (() => { try { return JSON.parse(text); } catch (_) { return null; } })();
        if (data.token) {
          currentUser = username;
          token = data.token;
          document.getElementById('loginSection').style.display = 'none';
          document.getElementById('chat').style.display = 'block';
          connectSocket();
          error.style.display = 'none';
        } else {
          showError(data.error || 'Login failed');
        }
      } catch (err) {
        showError(`Connection error: ${err?.message || err}`);
      }
    }

    function connectSocket() {
      const backendBaseUrl = getBackendBaseUrl() || window.location.origin;
      ensureSocketIoLoaded(backendBaseUrl).then((io) => {
        socket = io(backendBaseUrl, { auth: { token } });
        socket.on('connect', () => console.log('Connected'));
        socket.on('chat history', (messages) => {
          if (!Array.isArray(messages)) return;
          messages.forEach((m) => {
            renderMessage(m);
            if (m?.from && m.from !== currentUser && !sentReadFor.has(m.id)) {
              sendReadReceipt(m.id);
            }
          });
        });
        socket.on('chat message', (data) => {
          renderMessage(data);
          if (data.from !== currentUser && !sentReadFor.has(data.id)) {
            sendReadReceipt(data.id);
          }
        });
        socket.on('message read', ({ messageId }) => {
          const label = readLabels.get(messageId);
          if (label) label.style.visibility = 'visible';
        });
      }).catch(() => {
        showError('Chat server is not available from this host. Set localStorage backendUrl (e.g., https://your-server.com) to enable chat.');
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function sendMessage() {
      const msg = document.getElementById('msgInput').value;
      if (msg && socket) {
        socket.emit('chat message', msg);
        document.getElementById('msgInput').value = '';
      }
    }

    function renderMessage({ id, from, message, timestamp }) {
      if (id && document.querySelector(`[data-id="${id}"]`)) return;
      const isMe = from === currentUser;
      const row = document.createElement('div');
      row.className = `message-row ${isMe ? 'me' : 'them'}`;
      row.dataset.id = id;

      const column = document.createElement('div');
      column.className = 'message-col';

      const name = document.createElement('div');
      name.className = 'name-tag';
      name.textContent = isMe ? currentUser : from;
      column.appendChild(name);

      const messageLine = document.createElement('div');
      messageLine.className = 'message-line';

      const bubble = document.createElement('div');
      bubble.className = `bubble ${isMe ? 'me' : 'them'}`;

      const text = document.createElement('div');
      text.className = 'message-text';
      text.innerHTML = escapeHtml(message);
      bubble.appendChild(text);

      const meta = document.createElement('div');
      meta.className = 'meta';

      const time = document.createElement('span');
      const date = timestamp ? new Date(timestamp) : new Date();
      time.textContent = date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
      meta.appendChild(time);

      if (isMe) {
        const read = document.createElement('span');
        read.className = 'read-label';
        read.textContent = 'Read';
        meta.appendChild(read);
        readLabels.set(id, read);
      }

      messageLine.appendChild(bubble);
      column.appendChild(messageLine);
      column.appendChild(meta);
      row.appendChild(column);

      const msgBox = document.getElementById('messages');
      msgBox.appendChild(row);
      msgBox.scrollTop = msgBox.scrollHeight;
    }

    function sendReadReceipt(messageId) {
      if (!socket) return;
      socket.emit('message read', { messageId });
      sentReadFor.add(messageId);
    }

    function togglePassword(inputId, toggleId) {
      const input = document.getElementById(inputId);
      const toggle = document.getElementById(toggleId);
      const isHidden = input.type === 'password';
      input.type = isHidden ? 'text' : 'password';
      toggle.textContent = isHidden ? 'Hide' : 'Show';
    }

    document.getElementById('loginBtn').onclick = login;
    document.getElementById('sendBtn').onclick = sendMessage;
    document.getElementById('msgInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    document.getElementById('password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') login();
    });
    document.getElementById('togglePassword').onclick = () => togglePassword('password', 'togglePassword');

    window.addEventListener('load', () => {
      initBackendUi();
      initLoginProviders();
    });
  </script>
</body>
</html>
